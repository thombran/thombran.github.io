<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <meta http-equiv="refresh" content="0; url=404.html">
  <title>Image Upload with Firebase</title>
  <style>
    body { font-family: sans-serif; padding: 2rem; background: #f5f5f5; }
    .box { background: white; padding: 2rem; border-radius: 10px; max-width: 500px; margin: auto; }
    input[type="email"] { width: 100%; padding: 0.5rem; margin-bottom: 0.5rem; }
    button { padding: 0.5rem 1rem; margin-top: 0.5rem; }
    .drop-area { border: 2px dashed #ccc; padding: 2rem; text-align: center; margin-top: 1rem; border-radius: 8px; }
    .drop-area.highlight { background: #e0f7fa; border-color: #00bcd4; }
    .preview img { max-width: 100%; margin-top: 1rem; }
  </style>
</head>
<body>
  <div class="box">
    <h2>Sign-In with Email Link</h2>
    <div id="auth-container">
      <input type="email" id="email" placeholder="Enter your email" />
      <button onclick="sendSignInLink()">Send Sign-In Link</button>
    </div>
    <p id="signed-in-status">Not signed in</p>
    <button onclick="firebase.auth().signOut()">Sign Out</button>

    <div class="drop-area" id="drop-area">
      <p>Drag & drop an image here or click to select</p>
      <input type="file" id="fileElem" accept="image/*" style="display:none"/>
    </div>
    <div class="preview" id="preview"></div>
  </div>

  <!-- Firebase scripts -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-storage-compat.js"></script>

  <script>
    // 🔐 Your Firebase config (API key is public-safe)
    const firebaseConfig = {
      apiKey: "AIzaSyB8X9Kf5no8uisdS4VkfaO44IyWbAnuo80",
      authDomain: "high-extension-462219-i3.firebaseapp.com",
      projectId: "high-extension-462219-i3",
      storageBucket: "high-extension-462219-i3.firebasestorage.app",
      messagingSenderId: "695072102293",
      appId: "1:695072102293:web:9fa550e6c728ed11c3889c"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const storage = firebase.storage();

    window.addEventListener('load', async () => {
      if (auth.isSignInWithEmailLink(window.location.href)) {
        let email = localStorage.getItem('emailForSignIn') || window.prompt("Enter your email:");
        try {
          await auth.signInWithEmailLink(email, window.location.href);
          localStorage.removeItem('emailForSignIn');
        } catch (e) {
          console.error("Sign-in error:", e);
        }
      }
    });

    auth.onAuthStateChanged(user => {
      document.getElementById('signed-in-status').textContent = user
        ? `Signed in as ${user.email || user.uid}`
        : "Not signed in";
    });

    function sendSignInLink() {
      const email = document.getElementById("email").value;
      if (!email) return alert("Please enter an email!");

      const settings = {
        url: window.location.href,
        handleCodeInApp: true
      };

      auth.sendSignInLinkToEmail(email, settings)
        .then(() => {
          alert("Check your inbox for a sign-in link!");
          localStorage.setItem("emailForSignIn", email);
        })
        .catch(err => console.error("Send email link error:", err));
    }

    const dropArea = document.getElementById("drop-area");
    const fileElem = document.getElementById("fileElem");
    const preview = document.getElementById("preview");

    dropArea.addEventListener("click", () => fileElem.click());

    ['dragenter', 'dragover'].forEach(event => {
      dropArea.addEventListener(event, e => {
        e.preventDefault();
        dropArea.classList.add('highlight');
      });
    });

    ['dragleave', 'drop'].forEach(event => {
      dropArea.addEventListener(event, e => {
        e.preventDefault();
        dropArea.classList.remove('highlight');
      });
    });

    dropArea.addEventListener('drop', e => {
      const files = e.dataTransfer.files;
      if (files.length > 0) handleFile(files[0]);
    });

    fileElem.addEventListener('change', () => {
      if (fileElem.files.length > 0) handleFile(fileElem.files[0]);
    });

    function handleFile(file) {
      const user = firebase.auth().currentUser;
      if (!user) {
        alert("Sign in to upload.");
        return;
      }
      
      if (!file.type.startsWith("image/")) {
        alert("Please upload an image.");
        return;
      }
      
      if (file.size > 100 * 1024 * 1024) {
        alert("File must be under 100MB.");
        return;
      }

      // Show preview
      const img = document.createElement('img');
      img.src = URL.createObjectURL(file);
      img.onload = () => URL.revokeObjectURL(img.src);
      preview.innerHTML = '';
      preview.appendChild(img);

      // Upload file
      const fileRef = storage.ref(`uploads/${user.uid}/${file.name}`);
      fileRef.put(file)
        .then(url => {
          alert("Image upload complete!");
        })
        .catch(err => {
          console.error("Upload error:", err);
          alert("Image upload failed");
        });
    }
  </script>
</body>
</html>
